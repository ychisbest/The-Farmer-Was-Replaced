---
import { DEFAULT_LOCALE_SETTING, LOCALES_SETTING } from "@/locales";
import { useTranslations, type Lang } from "@/i18n";
import Layout from "@/layouts/BaseLayout.astro";
import CodeBlock from "@/components/CodeBlock.astro";
import { getRelativeLocaleUrl } from "astro:i18n";
import { images } from "@/lib/images";
import { Image } from "astro:assets";

const t = useTranslations(Astro.currentLocale as Lang);
const locale = Astro.currentLocale || DEFAULT_LOCALE_SETTING;

export const getStaticPaths = async () => {
    const paths = Object.keys(LOCALES_SETTING).map((lang) => {
        if (lang !== DEFAULT_LOCALE_SETTING) {
            return { params: { lang: lang } };
        } else {
            return { params: { lang: undefined } };
        }
    });
    return paths;
};

const title = {
    en: "Cactus Sorting Algorithm - The Farmer Was Replaced",
    zh: "仙人掌冒泡排序算法详解 - 编程农场",
    de: "Kaktus-Sortieralgorithmus - The Farmer Was Replaced",
};

const description = {
    en: "Learn how to implement a 2D Bubble Sort algorithm to automate cactus harvesting. Detailed tutorial with Python code explanation.",
    zh: "学习如何实现二维冒泡排序算法来自动化收获仙人掌。包含详细的 Python 代码原理解析。",
    de: "Lernen Sie, wie man einen 2D-Blasensortieralgorithmus implementiert, um die Kaktusernte zu automatisieren. Detailliertes Tutorial.",
};
---

<Layout title={title} description={description}>
    <div class="max-w-4xl mx-auto px-4">
        
        <section class="py-10 text-center border-b border-gray-200 dark:border-gray-700">
            <h1 class="text-3xl md:text-4xl font-extrabold mb-6 text-gray-900 dark:text-white">
                {t({
                    en: "Mastering Cactus Automation: 2D Bubble Sort",
                    zh: "精通仙人掌自动化：二维冒泡排序",
                    de: "Meisterung der Kaktus-Automatisierung: 2D-Blasensortierung"
                })}
            </h1>
            <p class="text-lg text-gray-600 dark:text-gray-300 max-w-2xl mx-auto">
                {t({
                    en: "Cactus farming is unique because sorting them by size can yield better rewards. This guide explains how to apply the classic Bubble Sort algorithm to your farm grid.",
                    zh: "仙人掌种植非常独特，因为按大小排序可以获得更好的奖励或满足关卡要求。本指南将解释如何将经典的“冒泡排序”算法应用到你的农场网格中。",
                    de: "Der Kaktusanbau ist einzigartig, da das Sortieren nach Größe bessere Belohnungen bringen kann. Dieser Leitfaden erklärt, wie man Bubble Sort anwendet."
                })}
            </p>
        </section>

        <section class="py-10 grid md:grid-cols-2 gap-8 items-center">
            <div class="order-2 md:order-1">
                <h2 class="text-2xl font-bold mb-4 text-green-700 dark:text-green-400">
                    {t({
                        en: "The Strategy",
                        zh: "核心策略",
                        de: "Die Strategie"
                    })}
                </h2>
                <div class="prose dark:prose-invert text-gray-700 dark:text-gray-300 space-y-4">
                    <p>
                        {t({
                            en: "Unlike other crops, simply harvesting cacti isn't enough. We need to measure them and swap their positions until they are perfectly ordered.",
                            zh: "与其他作物不同，仅仅收获仙人掌是不够的。我们需要测量它们的大小，并不断交换它们的位置，直到它们被完美地排列。",
                            de: "Im Gegensatz zu anderen Pflanzen reicht das bloße Ernten von Kakteen nicht aus. Wir müssen sie messen und tauschen."
                        })}
                    </p>
                    <ul class="list-disc pl-5 space-y-2">
                        <li>
                            <strong>{t({ zh: "测量 (Measure):", en: "Measure:", de: "Messen:" })}</strong> 
                            {t({ zh: "比较当前位置与相邻位置（右侧和下方）的仙人掌大小。", en: "Compare current cactus size with neighbors.", de: "Vergleiche aktuelle Kaktusgröße mit Nachbarn." })}
                        </li>
                        <li>
                            <strong>{t({ zh: "交换 (Swap):", en: "Swap:", de: "Tauschen:" })}</strong> 
                            {t({ zh: "如果当前仙人掌比邻居大，则交换位置。", en: "If current is larger than neighbor, swap them.", de: "Wenn der aktuelle größer ist, tausche sie." })}
                        </li>
                        <li>
                            <strong>{t({ zh: "重复 (Repeat):", en: "Repeat:", de: "Wiederholen:" })}</strong> 
                            {t({ zh: "在整个网格上重复此过程，直到没有需要交换的为止。", en: "Repeat across the grid until no swaps are needed.", de: "Wiederhole dies über das Raster." })}
                        </li>
                    </ul>
                </div>
            </div>
            <div class="order-1 md:order-2">
                <div class="bg-gray-100 dark:bg-gray-800 p-2 rounded-2xl shadow-lg rotate-1 hover:rotate-0 transition duration-500">
                    <Image class="rounded-xl w-full" alt="Cactus Sorting Visualization" src={images[4]} />
                </div>
            </div>
        </section>

        <section class="py-10">
            <h2 class="text-2xl font-bold mb-8 text-center">
                {t({
                    en: "Step-by-Step Code Analysis",
                    zh: "代码分步解析",
                    de: "Schritt-für-Schritt Code-Analyse"
                })}
            </h2>

            <div class="mb-12 bg-white dark:bg-gray-800 p-6 rounded-xl border border-gray-200 dark:border-gray-700">
                <h3 class="text-xl font-bold mb-3 flex items-center gap-2">
                    <span class="bg-blue-100 text-blue-800 text-sm font-medium px-2.5 py-0.5 rounded dark:bg-blue-900 dark:text-blue-300">Step 1</span>
                    {t({ zh: "智能导航与方向控制", en: "Smart Navigation & Direction", de: "Intelligente Navigation" })}
                </h3>
                <p class="mb-4 text-gray-600 dark:text-gray-400">
                    {t({
                        zh: "在排序之前，我们需要一些辅助函数来帮助无人机回到原点 (`back`) 以及处理方向的反转 (`reverse`)。",
                        en: "Before sorting, we need helper functions to return the drone to origin (`back`) and handle direction reversal (`reverse`).",
                        de: "Vor dem Sortieren benötigen wir Hilfsfunktionen."
                    })}
                </p>
                <CodeBlock code={`def back(x=0,y=0):
    while x!=get_pos_x() or y!=get_pos_y():
        if(get_pos_x()<x):
            move(East)
        elif(get_pos_x()>x):
            move(West)
        if(get_pos_y()<y):
            move(North)
        elif(get_pos_y()>y):
            move(South)

def reverse(dir):
    opposite = {West:East, East:West, North:South, South:North}
    return opposite[dir]`} />
            </div>

            <div class="mb-12 bg-white dark:bg-gray-800 p-6 rounded-xl border border-gray-200 dark:border-gray-700">
                <h3 class="text-xl font-bold mb-3 flex items-center gap-2">
                    <span class="bg-yellow-100 text-yellow-800 text-sm font-medium px-2.5 py-0.5 rounded dark:bg-yellow-900 dark:text-yellow-300">Step 2</span>
                    {t({ zh: "核心排序逻辑 (Bubble Sort)", en: "Core Sorting Logic", de: "Kern-Sortierlogik" })}
                </h3>
                <p class="mb-4 text-gray-600 dark:text-gray-400">
                    {t({
                        zh: "这是代码的大脑部分。它不仅检查水平方向 (`East`/`West`)，还检查垂直方向 (`North`/`South`)。如果发现顺序错误，就调用 `swap()`。",
                        en: "This is the brain of the code. It checks not just horizontally but also vertically. If the order is wrong, it calls `swap()`.",
                        de: "Das ist das Gehirn des Codes. Es prüft horizontal und vertikal."
                    })}
                </p>
                <CodeBlock code={`# ... inside the loop
current=measure()
neighbor=measure(dir)
down=measure(South)
up=measure(North)

# Swap Horizontal (水平交换)
if(x!=size-1 and neighbor!=None and dir==East and current>neighbor):
    swap(East)
    sorted=False # Mark as not fully sorted yet

# Swap Vertical (垂直交换)
if(y!=0 and down != None and current<down):
    swap(South)
    vsorted=False`} />
            </div>
        </section>

        <section class="mb-16">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-2xl font-bold">
                    {t({
                        en: "Complete Source Code",
                        zh: "完整源代码",
                        de: "Vollständiger Quellcode"
                    })}
                </h2>
                <span class="text-sm text-gray-500 bg-gray-100 dark:bg-gray-800 px-3 py-1 rounded-full">
                    Python
                </span>
            </div>
            
            <div class="relative group">
                <div class="absolute -inset-1 bg-gradient-to-r from-green-600 to-blue-600 rounded-lg blur opacity-25 group-hover:opacity-50 transition duration-1000 group-hover:duration-200"></div>
                <div class="relative">
                    <CodeBlock
                        height="max-h-[800px]"
                        code={`def back(x=0,y=0):
    while x!=get_pos_x() or y!=get_pos_y():
        if(get_pos_x()<x):
            move(East)
        elif(get_pos_x()>x):
            move(West)
        if(get_pos_y()<y):
            move(North)
        elif(get_pos_y()>y):
            move(South)

def plantCactus():
    if get_ground_type()==Grounds.Grassland:
        till()
    plant(Entities.Cactus)  

def reverse(dir):
    opposite = {West:East, East:West, North:South, South:North}
    return opposite[dir]

def cactusProject(size=3):
    while True:
        dir=East
        vdir=North
        sorted=False
        vsorted=False
        
        # 1. Planting Phase
        for i in range(size):
            for j in range(size):
                plantCactus()
                if(j!=size-1):
                    move(dir)
            if(i!=size-1):
                move(vdir)
            dir=reverse(dir)
        vdir=reverse(vdir)
        
        # 2. Sorting Phase
        while not sorted or not vsorted:
            sorted=True
            vsorted=True
            for i in range(size):
                for j in range(size):
                    x=get_pos_x()
                    y=get_pos_y()
                    current=measure()
                    neighbor=measure(dir)
                    down=measure(South)
                    up=measure(North)
                    
                    # Logic to swap East/West
                    if(x!=size-1 and neighbor!=None and dir==East and current>neighbor):
                        swap(East)
                        sorted=False
                    if(x!=0 and neighbor!=None and dir==West and current<neighbor):
                        swap(West)
                        sorted=False
                        
                    # Logic to swap North/South
                    if(y!=0 and down != None and current<down):
                        swap(South)
                        vsorted=False
                    if(y!=size-1 and up != None and current>up):
                        swap(North)
                        vsorted=False
                        
                    if(j!=size-1):
                        move(dir)
                if(i!=size-1):
                    move(vdir)
                dir=reverse(dir)
            vdir = reverse(vdir)
        
        # 3. Harvesting Phase (Once sorted)
        back()
        harvest()
        
clear()
# Change '6' to your grid size
cactusProject(6)`}
                    />
                </div>
            </div>
        </section>

        <section class="py-8 bg-green-50 dark:bg-green-900/20 rounded-2xl border border-green-100 dark:border-green-800 p-6 mb-12">
            <h3 class="text-xl font-bold mb-4 flex items-center gap-2 text-green-800 dark:text-green-300">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                </svg>
                {t({ zh: "优化建议", en: "Optimization Tips", de: "Optimierungstipps" })}
            </h3>
            <ul class="space-y-2 text-green-900 dark:text-green-100">
                <li class="flex items-start gap-2">
                    <span class="font-bold">•</span>
                    {t({
                        zh: "确保传入 `cactusProject(size)` 的 size 参数与你的土地大小一致，否则无人机会撞墙。",
                        en: "Ensure the `size` parameter matches your actual land size to avoid drone crashes.",
                        de: "Stellen Sie sicher, dass der Parameter `size` mit der tatsächlichen Landgröße übereinstimmt."
                    })}
                </li>
                <li class="flex items-start gap-2">
                    <span class="font-bold">•</span>
                    {t({
                        zh: "这个算法在大型网格（如 10x10）上可能会变慢，这是冒泡排序的特性。",
                        en: "This algorithm might be slow on large grids (e.g., 10x10) due to the nature of Bubble Sort.",
                        de: "Dieser Algorithmus könnte auf großen Rastern langsam sein."
                    })}
                </li>
            </ul>
        </section>

        <section class="py-8 border-t border-neutral-200 dark:border-neutral-700">
            <div class="flex justify-center">
                <a href={getRelativeLocaleUrl(locale, "/")} class="inline-flex items-center gap-2 px-6 py-3 bg-gray-100 hover:bg-gray-200 dark:bg-gray-800 dark:hover:bg-gray-700 rounded-full transition text-gray-700 dark:text-gray-300 font-medium">
                    <span>←</span>
                    {t({
                        en: "Back to Home",
                        zh: "返回主页",
                        de: "Zurück zur Startseite"
                    })}
                </a>
            </div>
        </section>
        
        <div id="utterances-container" class="my-10"></div>
    </div>
</Layout>